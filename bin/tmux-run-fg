#!/usr/bin/env sh

# Replaces pane's contents with output of a command, then swaps back when the command exists.
# Example usage: tmux-run-fg "echo hi; sleep 1"
# TODO: Replace zoom management with `swap-pane -Z` when tmux 3.1 is popular enough.

PROCESSES_SESSION='temp-commands'

if [ "$#" -ne 1 ]; then
    echo "Usage: $0 command"
    exit
fi

if ! tmux list-sessions -F '#S' | grep -q "^$PROCESSES_SESSION\$"; then
    tmux new-session -s "$PROCESSES_SESSION" -d
fi

current_pane="$(tmux display-message -F '#D' -p)"
is_zoomed="$(tmux display-message -p -F '#{window_zoomed_flag}')"
[ "$is_zoomed" -eq 1 ] && resize_cmd="tmux resize-pane -t $current_pane -Z"
temp_window="$(tr -dc 'a-zA-Z0-9' < /dev/urandom | head -c 32)"
# The trap is in here to prevent a C-c from taking our terminal away from us.
tmux new-window -t "$PROCESSES_SESSION" -n "$temp_window" "trap true INT; $1; tmux swap-pane -t $current_pane; $resize_cmd"
temp_pane="$(tmux list-panes -t "$PROCESSES_SESSION" -F '#D')"
tmux swap-pane -s "$current_pane" -t "$PROCESSES_SESSION:$temp_window"
[ "$is_zoomed" -eq 1 ] && tmux resize-pane -t "$temp_pane" -Z
true  # Otherwise tmux interrupts us with the return code.
